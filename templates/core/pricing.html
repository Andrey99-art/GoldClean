<!-- File: templates/core/pricing.html (ИСПРАВЛЕННАЯ ВЕРСИЯ) -->
{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Pricing" %} - Gold Clean{% endblock %}
{% block meta_description %}{% trans "Transparent cleaning prices in Warsaw. No hidden fees. Check our calculator for regular cleaning, window washing, and dry cleaning costs." %}{% endblock %}

{% block content %}
<div class="container py-3">
    <!-- HINT: Добавлен id для связи с кнопкой -->
    <form action="{% url 'orders:start_order_from_list' %}" method="post" id="service-selection-form">
        {% csrf_token %}
        <div class="pricing-header p-3 pb-md-4 mx-auto text-center">
            <h1 class="display-4 fw-normal">{% trans "Pricing" %}</h1>
            <p class="fs-5 text-muted">{% trans "Choose the perfect cleaning plan for your home. All prices are starting points and can be customized with additional services." %}</p>
        </div>

        <h2 class="display-6 text-center mb-4">{% trans "Main Services" %}</h2>
        <div class="row justify-content-center">
            {% for service in main_services %}
            <div class="col-lg-4 col-md-6 mb-4">
                <label class="service-card-selectable h-100">
                    <input type="radio" name="main_service" value="{{ service.id }}" class="form-check-input" required data-price="{{ service.base_price }}">
                    <div class="card rounded-3 shadow-sm h-100">
                        <div class="card-header py-3">
                            <h4 class="my-0 fw-normal">{{ service.name }}</h4>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h1 class="card-title pricing-card-title">
                                {{ service.base_price|floatformat:0 }} zł<small class="text-muted fw-light">/{% trans "start" %}</small>
                            </h1>
                            <ul class="list-unstyled mt-3 mb-4">
                                {% for feature in service.features.all %}
                                    <li>{{ feature.description }}</li>
                                {% empty %}
                                    <li>{% trans "Description coming soon." %}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>

        <h2 class="display-6 text-center mb-4 mt-5">{% trans "Additional Services" %}</h2>
        <div class="list-group w-lg-75 mx-auto shadow-sm">
            {% for add_service in additional_services %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    {% if not add_service.is_quantity_based %}
                        <input class="form-check-input me-2" type="checkbox" id="add-service-price-{{ add_service.id }}" data-service-id="{{ add_service.id }}">
                    {% endif %}
                    <label class="form-check-label" for="add-service-price-{{ add_service.id }}">
                        {{ add_service.name }}
                    </label>
                </div>
                
                <div class="d-flex align-items-center">
                    {% if add_service.is_quantity_based %}
                    <div class="quantity-widget d-flex align-items-center me-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" data-service-id="{{ add_service.id }}" data-action="decrease">-</button>
                        <input type="number" class="form-control form-control-sm text-center quantity-input" value="0" min="0" max="10" data-service-id="{{ add_service.id }}" style="width: 60px;">
                        <button type="button" class="btn btn-outline-secondary btn-sm quantity-btn" data-service-id="{{ add_service.id }}" data-action="increase">+</button>
                    </div>
                    {% endif %}
                    <span class="badge bg-primary rounded-pill fs-6">+ {{ add_service.price|floatformat:0 }} zł</span>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ======================================================= -->
        <!--      БЛОК КАЛЬКУЛЯТОРА БЫЛ УДАЛЕН ОТСЮДА              -->
        <!-- ======================================================= -->
    </form>
</div> <!-- <== КОНТЕЙНЕР ЗАКРЫВАЕТСЯ ЗДЕСЬ -->

<!-- ======================================================= -->
<!--      НОВОЕ РАСПОЛОЖЕНИЕ БЛОКА КАЛЬКУЛЯТОРА            -->
<!-- ======================================================= -->
<div class="order-footer-bar">
    <div class="total-price-display">
        {% trans "Total" %}: <span id="total-price-value">0.00 zł</span>
    </div>
    <!-- HINT: Атрибут 'form' связывает эту кнопку с формой выше -->
    <button type="submit" form="service-selection-form" class="btn btn-primary btn-lg">{% trans "Proceed to order" %}</button>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Ваш JavaScript остается без изменений, он будет работать как и раньше
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('service-selection-form');
    // ... остальной JS-код ...
    if (form) {
        const totalPriceEl = document.getElementById('total-price-value');

        function handleQuantityButtons() {
            form.addEventListener('click', function(event) {
                if (!event.target.classList.contains('quantity-btn')) return;
                
                const action = event.target.dataset.action;
                const serviceId = event.target.dataset.serviceId;
                const input = form.querySelector(`.quantity-input[data-service-id="${serviceId}"]`);
                if (!input) return;

                let currentValue = parseInt(input.value);
                const max = parseInt(input.max);
                const min = parseInt(input.min);

                if (action === 'increase' && currentValue < max) {
                    input.value = currentValue + 1;
                } else if (action === 'decrease' && currentValue > min) {
                    input.value = currentValue - 1;
                }
                form.dispatchEvent(new Event('change', { bubbles: true }));
            });
        }

        function updateTotalPrice() {
            let total = 0;
            
            const selectedMainService = form.querySelector('input[name="main_service"]:checked');
            if (selectedMainService) {
                total += parseFloat(selectedMainService.dataset.price);
            }

            const serviceElements = form.querySelectorAll('[data-service-id]');
            serviceElements.forEach(el => {
                const serviceId = el.dataset.serviceId;
                const serviceWrapper = el.closest('.list-group-item') || el.closest('.form-check');
                if (!serviceWrapper) return;
                
                const priceText = serviceWrapper.querySelector('.badge')?.textContent || '';
                const priceMatch = priceText.match(/[\d,.]+/);
                if (!priceMatch) return;
                const price = parseFloat(priceMatch[0]);

                if (el.type === 'checkbox' && el.checked) {
                    total += price;
                } else if (el.classList.contains('quantity-input')) {
                    const quantity = parseInt(el.value);
                    if (quantity > 0) {
                        total += price * quantity;
                    }
                }
            });

            totalPriceEl.textContent = total.toFixed(2) + ' zł';
        }

        form.addEventListener('change', updateTotalPrice);
        form.addEventListener('input', updateTotalPrice);
        handleQuantityButtons();
        updateTotalPrice();
    }
});
</script>
{% endblock %}